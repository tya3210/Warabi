<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>総合防災支援アプリ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        .locate-button {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--safe-green);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --emergency-red: #e74c3c;
            --safe-green: #2ecc71;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #main-map {
            flex: 1;
            background: #f8f9fa;
            position: relative;
        }

        .sidebar {
            width: 100%;
            max-width: 400px;
            background: white;
            box-shadow: -2px 0 15px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            right: -100%;
            bottom: 0;
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.active {
            transform: translateX(-100%);
        }

        .tab-header {
            display: flex;
            border-bottom: 1px solid #eee;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: var(--secondary-color);
            color: white;
        }

        .tab-content {
            padding: 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .medical-form .form-group {
            margin-bottom: 15px;
        }

        .medical-form label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .medical-form textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        .message-list {
            margin-top: 15px;
        }

        .message-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
        }

        .floating-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 1100;
        }

        .emergency-alert {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--emergency-red);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            animation: pulse 1.5s infinite;
            z-index: 1200;
            display: none;
        }

        .context-menu {
            position: absolute;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10000;
            border-radius: 6px;
            padding: 8px 0;
            display: none;
        }

        .context-menu-item {
            padding: 8px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #f5f5f5;
        }

        .username-tag {
            position: absolute;
            background: var(--secondary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            transform: translateY(-32px);
            white-space: nowrap;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @media (min-width: 768px) {
            #app-container {
                flex-direction: row;
            }

            .sidebar {
                position: relative;
                right: 0;
                transform: none;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <button class="locate-button" id="locate-button">📍</button>

    <script>
        // 既存のstateオブジェクトに現在地情報を追加
        const state = {
            // ...既存のプロパティ...
            currentLocation: null,
            locationMarker: null
        };

        // 現在地取得機能の追加
        function setupGeolocation() {
            const locateButton = document.getElementById('locate-button');
            
            // 位置情報取得処理
            const getLocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            // 現在地の更新
                            state.currentLocation = pos;
                            
                            // マーカーの更新
                            if (state.locationMarker) {
                                state.map.removeLayer(state.locationMarker);
                            }
                            
                            // 新しいマーカーを追加
                            state.locationMarker = L.marker([pos.lat, pos.lng], {
                                icon: L.divIcon({
                                    className: 'current-location-marker',
                                    html: '📍',
                                    iconSize: [40, 40]
                                })
                            }).addTo(state.map);
                            
                            // 地図を現在地に移動
                            state.map.setView([pos.lat, pos.lng], 16);
                        },
                        error => {
                            handleLocationError(error);
                        }
                    );
                } else {
                    alert("お使いのブラウザは位置情報をサポートしていません");
                }
            };

            // エラーハンドリング
            const handleLocationError = error => {
                let message = "位置情報を取得できませんでした";
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = "位置情報の利用が許可されていません";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = "位置情報が利用できません";
                        break;
                    case error.TIMEOUT:
                        message = "位置情報の取得がタイムアウトしました";
                        break;
                }
                showAlert(message, 'error');
            };

            // ボタンクリックイベント
            locateButton.addEventListener('click', getLocation);
        }

        // 初期化処理に追加
        function initApp() {
            initMap();
            setupMedicalData();
            setupMessages();
            setupUI();
            setupGeolocation(); // ← 追加
        }
    <div id="app-container">
        <div id="main-map"></div>

        <div class="sidebar">
            <div class="tab-header">
                <button class="tab-button active" data-tab="hazard">ハザード</button>
                <button class="tab-button" data-tab="medical">健康情報</button>
                <button class="tab-button" data-tab="messages">伝言板</button>
            </div>

            <div id="hazard" class="tab-content active">
                <h2 style="padding: 20px;">ハザードマップ設定</h2>
                <div style="padding: 0 20px 20px;">
                    <label class="layer-toggle">
                        <input type="checkbox" id="flood-layer">
                        洪水リスク
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" id="landslide-layer">
                        土砂災害リスク
                    </label>
                </div>
            </div>

            <div id="medical" class="tab-content">
                <div style="padding: 20px;">
                    <h2>防災カルテ</h2>
                    <form class="medical-form">
                        <div class="form-group">
                            <label>健康状態</label>
                            <textarea id="health-status" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>アレルギー情報</label>
                            <textarea id="allergies" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>常用薬</label>
                            <textarea id="medications" rows="3"></textarea>
                        </div>
                        <button type="button" class="save-button" style="margin-top: 15px; padding: 10px 20px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            保存
                        </button>
                    </form>
                </div>
            </div>

            <div id="messages" class="tab-content">
                <div style="padding: 20px;">
                    <h2>伝言板</h2>
                    <div class="message-list" id="message-list"></div>
                    <button class="add-message-button" style="margin-top: 15px; padding: 10px 20px; background: var(--safe-green); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        新しい伝言を追加
                    </button>
                </div>
            </div>
        </div>

        <div class="emergency-alert" id="emergency-alert">
            🚨 緊急事態！直ちに避難してください！
        </div>

        <button class="floating-button" id="menu-button">☰</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const state = {
            map: null,
            layers: {
                flood: L.layerGroup(),
                landslide: L.layerGroup()
            },
            messages: JSON.parse(localStorage.getItem('messages')) || [],
            medicalData: JSON.parse(localStorage.getItem('medicalData')) || {},
            currentMarker: null,
            longPressTimer: null
        };

        function initMap() {
            state.map = L.map('main-map', {
                center: [35.681236, 139.767125],
                zoom: 13,
                preferCanvas: true
            });

            L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
                attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>',
                maxZoom: 18,
                minZoom: 5
            }).addTo(state.map);

            L.rectangle([[35.67, 139.75], [35.69, 139.77]], {
                color: "#0066ff",
                fillOpacity: 0.2
            }).addTo(state.layers.flood);

            L.polygon([
                [35.68, 139.76],
                [35.685, 139.765],
                [35.68, 139.77]
            ], {
                color: "#ff6600",
                fillOpacity: 0.2
            }).addTo(state.layers.landslide);
        }

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('保存エラー:', e);
                showAlert('データの保存に失敗しました', 'error');
                return false;
            }
        }

        function setupMessages() {
            const renderMessages = () => {
                const container = document.getElementById('message-list');
                container.innerHTML = state.messages.map((msg, index) => `
                    <div class="message-item" data-index="${index}">
                        <p>${msg.user ? `<strong>${msg.user}:</strong> ` : ''}${msg.text}</p>
                        <small>
                            ${new Date(msg.timestamp).toLocaleString()} 
                            (${msg.coords.lat.toFixed(4)}, ${msg.coords.lng.toFixed(4)})
                        </small>
                    </div>
                `).join('');
            };

            const addMarkerWithUsername = (msg) => {
                const marker = L.marker(msg.coords)
                    .addTo(state.map)
                    .bindPopup(`<b>${msg.user || '匿名'}</b><br>${msg.text}`);
                
                if (msg.user) {
                    const usernameTag = L.divIcon({
                        className: 'username-tag',
                        html: msg.user,
                        iconSize: [null, 24]
                    });
                    L.marker(msg.coords, { icon: usernameTag }).addTo(state.map);
                }

                marker.on('mousedown', (e) => handleLongPressStart(e, marker));
                marker.on('mouseup', handleLongPressEnd);
                marker.on('mouseout', handleLongPressEnd);

                return marker;
            };

            state.messages.forEach(msg => {
                msg.marker = addMarkerWithUsername(msg);
            });

            document.querySelector('.add-message-button').addEventListener('click', async () => {
                const user = prompt('ユーザー名を入力（任意）:') || '匿名';
                const message = prompt('伝言を入力（300文字以内）:');
                
                if (message && message.length <= 300) {
                    state.map.once('click', e => {
                        const newMsg = {
                            user,
                            text: message,
                            coords: e.latlng,
                            timestamp: Date.now()
                        };
                        
                        newMsg.marker = addMarkerWithUsername(newMsg);
                        state.messages.push(newMsg);
                        saveToStorage('messages', state.messages);
                        renderMessages();
                    });
                    alert('地図上の位置を選択してください');
                }
            });

            renderMessages();
        }

        function handleLongPressStart(e, marker) {
            state.currentMarker = marker;
            state.longPressTimer = setTimeout(() => {
                showContextMenu(e.originalEvent.clientX, e.originalEvent.clientY);
            }, 1000);
        }

        function handleLongPressEnd() {
            clearTimeout(state.longPressTimer);
        }

        function showContextMenu(x, y) {
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            
            menu.innerHTML = `
                <div class="context-menu-item" onclick="handleEditMessage()">編集</div>
                <div class="context-menu-item" onclick="handleDeleteMessage()">削除</div>
            `;
            
            document.body.appendChild(menu);
            menu.style.display = 'block';
            
            const closeMenu = () => {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            };
            
            document.addEventListener('click', closeMenu);
        }

        window.handleEditMessage = () => {
            if (!state.currentMarker) return;
            
            const msgIndex = state.messages.findIndex(m => m.marker === state.currentMarker);
            const newText = prompt('メッセージを編集:', state.messages[msgIndex].text);
            
            if (newText && newText.length <= 300) {
                state.messages[msgIndex].text = newText;
                state.currentMarker.setPopupContent(`<b>${state.messages[msgIndex].user || '匿名'}</b><br>${newText}`);
                saveToStorage('messages', state.messages);
                document.querySelector(`.message-item[data-index="${msgIndex}"] p`).innerHTML = 
                    `${state.messages[msgIndex].user ? `<strong>${state.messages[msgIndex].user}:</strong> ` : ''}${newText}`;
            }
        };

        window.handleDeleteMessage = () => {
            if (!state.currentMarker) return;
            
            if (confirm('本当に削除しますか？')) {
                const msgIndex = state.messages.findIndex(m => m.marker === state.currentMarker);
                state.map.removeLayer(state.messages[msgIndex].marker);
                state.messages.splice(msgIndex, 1);
                saveToStorage('messages', state.messages);
                document.querySelector(`.message-item[data-index="${msgIndex}"]`).remove();
            }
        };

        function setupMedicalData() {
            const loadData = () => {
                document.getElementById('health-status').value = state.medicalData.healthStatus || '';
                document.getElementById('allergies').value = state.medicalData.allergies || '';
                document.getElementById('medications').value = state.medicalData.medications || '';
            };

            document.querySelector('.save-button').addEventListener('click', () => {
                state.medicalData = {
                    healthStatus: document.getElementById('health-status').value,
                    allergies: document.getElementById('allergies').value,
                    medications: document.getElementById('medications').value,
                    lastUpdated: Date.now()
                };
                if (saveToStorage('medicalData', state.medicalData)) {
                    showAlert('健康情報を保存しました', 'success');
                }
            });

            loadData();
        }

        function setupUI() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    const tabId = button.dataset.tab;
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            document.querySelectorAll('.layer-toggle input').forEach(toggle => {
                toggle.addEventListener('change', e => {
                    const layer = e.target.id.replace('-layer', '');
                    if (e.target.checked) {
                        state.layers[layer].addTo(state.map);
                    } else {
                        state.map.removeLayer(state.layers[layer]);
                    }
                });
            });

            document.getElementById('menu-button').addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('active');
            });
        }

        function showAlert(message, type = 'info') {
            const alertBox = document.createElement('div');
            alertBox.className = `alert-${type}`;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => alertBox.remove(), 3000);
        }

        function initApp() {
            initMap();
            setupMedicalData();
            setupMessages();
            setupUI();
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
