<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>防災サポートアプリ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* スタイリング */
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; }
        .tab button:hover { background-color: #ddd; }
        .tab button.active { background-color: #ccc; }
        .tabcontent { display: none; padding: 6px 12px; border: 1px solid #ccc; border-top: none; }
        #map { height: 400px; margin: 10px 0; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .item-card { border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <!-- タブナビゲーション -->
    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'supplies')">防災グッズ</button>
        <button class="tablinks" onclick="openTab(event, 'map')">地図</button>
        <button class="tablinks" onclick="openTab(event, 'bulletin')">掲示板</button>
        <button class="tablinks" onclick="openTab(event, 'log')">行動ログ</button>
    </div>

    <!-- 防災グッズ管理 -->
    <div id="supplies" class="tabcontent">
        <h3>防災グッズ管理</h3>
        <div class="item-grid" id="suppliesList"></div>
        <button onclick="showAddItemForm()">新しいアイテムを追加</button>
    </div>

    <!-- 地図表示 -->
    <div id="map" class="tabcontent">
        <div id="mapContainer"></div>
        <select id="layerSelect" onchange="changeLayer()">
            <option value="shelters">避難所</option>
            <option value="messages">伝言板</option>
            <option value="shops">営業店舗</option>
        </select>
    </div>

    <!-- 伝言掲示板 -->
    <div id="bulletin" class="tabcontent">
        <h3>地域掲示板</h3>
        <div id="messagesList"></div>
        <textarea id="newMessage" placeholder="メッセージを入力"></textarea>
        <button onclick="postMessage()">投稿</button>
    </div>

    <!-- 行動ログ -->
    <div id="log" class="tabcontent">
        <h3>防災行動ログ</h3>
        <div id="logEntries"></div>
        <textarea id="newLog" placeholder="経験を記録"></textarea>
        <button onclick="addLogEntry()">追加</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // データストレージ
        let appData = JSON.parse(localStorage.getItem('disasterAppData')) || {
            supplies: [],
            messages: [],
            logs: [],
            shelters: []
        };

        // 地図初期化
        let map = L.map('mapContainer').setView([35.681236, 139.767125], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // タブ機能
        function openTab(evt, tabName) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.className += ' active';
        }

        // 防災グッズ管理
        function renderSupplies() {
            const container = document.getElementById('suppliesList');
            container.innerHTML = appData.supplies.map(item => `
                <div class="item-card">
                    <h4>${item.name}</h4>
                    <p>数量: ${item.quantity}</p>
                    <p>期限: ${item.expiry}</p>
                </div>
            `).join('');
        }

        function showAddItemForm() {
            const name = prompt('アイテム名を入力:');
            const quantity = prompt('数量を入力:');
            const expiry = prompt('期限を入力:');
            if (name && quantity && expiry) {
                appData.supplies.push({ name, quantity, expiry });
                saveData();
                renderSupplies();
            }
        }

        // 掲示板機能
        function postMessage() {
            const text = document.getElementById('newMessage').value;
            if (text) {
                appData.messages.push({
                    text,
                    date: new Date().toLocaleString(),
                    location: [map.getCenter().lat, map.getCenter().lng]
                });
                saveData();
                renderMessages();
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesList');
            container.innerHTML = appData.messages.map(msg => `
                <div class="message">
                    <p>${msg.date}</p>
                    <p>${msg.text}</p>
                </div>
            `).join('');
        }

        // 行動ログ
        function addLogEntry() {
            const text = document.getElementById('newLog').value;
            if (text) {
                appData.logs.push({
                    text,
                    date: new Date().toLocaleString(),
                    advice: generateAdvice(text)
                });
                saveData();
                renderLogs();
            }
        }

        function generateAdvice(text) {
            // 簡易AIアドバイス（ダミーデータ）
            const keywords = {
                '水': '水の備蓄は1人3リットル/日が目安です',
                '懐中電灯': 'LEDタイプが電池寿命が長くおすすめです',
                '避難所': '事前に複数の避難経路を確認しましょう'
            };
            return Object.entries(keywords).find(([k]) => text.includes(k))?.[1] || '定期的な防災訓練が重要です';
        }

        function renderLogs() {
            const container = document.getElementById('logEntries');
            container.innerHTML = appData.logs.map(log => `
                <div class="log-entry">
                    <p>${log.date} - ${log.text}</p>
                    <p class="advice">アドバイス: ${log.advice}</p>
                </div>
            `).join('');
        }

        // データ保存
        function saveData() {
            localStorage.setItem('disasterAppData', JSON.stringify(appData));
        }

        // 初期表示
        document.getElementById('supplies').style.display = 'block';
        renderSupplies();
        renderMessages();
        renderLogs();
    </script>
</body>
</html>
