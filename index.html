<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>防災サポートアプリ - 国土地理院地図版</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 20px; font-family: "Meiryo", sans-serif; }
        .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; }
        .tab button:hover { background-color: #ddd; }
        .tab button.active { background-color: #ccc; }
        .tabcontent { display: none; padding: 6px 12px; border: 1px solid #ccc; border-top: none; }
        #mapContainer { height: 500px; margin: 10px 0; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .item-card { border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin: 5px; }
        .message { background-color: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .layer-control { position: absolute; top: 100px; right: 10px; z-index: 1000; background: white; padding: 10px; }
    </style>
</head>
<body>
    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'supplies')">防災グッズ</button>
        <button class="tablinks" onclick="openTab(event, 'map')">地図</button>
        <button class="tablinks" onclick="openTab(event, 'bulletin')">掲示板</button>
        <button class="tablinks" onclick="openTab(event, 'log')">行動ログ</button>
    </div>

    <div id="supplies" class="tabcontent">
        <h3>防災グッズ管理</h3>
        <div class="item-grid" id="suppliesList"></div>
        <button onclick="showAddItemForm()">新しいアイテムを追加</button>
    </div>

    <div id="map" class="tabcontent">
        <div class="layer-control">
            <select id="layerSelect" onchange="changeLayer()">
                <option value="std">標準地図</option>
                <option value="relief">色別標高図</option>
                <option value="ort">航空写真</option>
            </select>
        </div>
        <div id="mapContainer"></div>
    </div>

    <div id="bulletin" class="tabcontent">
        <h3>地域掲示板</h3>
        <div id="messagesList"></div>
        <textarea id="newMessage" placeholder="メッセージを入力（140字以内）" maxlength="140"></textarea>
        <button onclick="postMessage()">投稿</button>
    </div>

    <div id="log" class="tabcontent">
        <h3>防災行動ログ</h3>
        <div id="logEntries"></div>
        <textarea id="newLog" placeholder="経験を記録"></textarea>
        <button onclick="addLogEntry()">追加</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // 国土地理院タイルレイヤー設定
        const gsiLayers = {
            std: L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
                attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>'
            }),
            relief: L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png', {
                attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>'
            }),
            ort: L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', {
                attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>'
            })
        };

        // 地図初期化
        const map = L.map('mapContainer', {
            center: [35.681236, 139.767125],
            zoom: 13,
            layers: [gsiLayers.std]
        });

        // データストレージ
        let appData = JSON.parse(localStorage.getItem('disasterAppData')) || {
            supplies: [],
            messages: [],
            logs: [],
            shelters: []
        };

        // タブ機能
        function openTab(evt, tabName) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.className += ' active';
        }

        // 防災グッズ管理
        function renderSupplies() {
            const container = document.getElementById('suppliesList');
            container.innerHTML = appData.supplies.map(item => `
                <div class="item-card">
                    <h4>${item.name}</h4>
                    <p>数量: ${item.quantity}</p>
                    <p>期限: ${item.expiry}</p>
                    <button onclick="deleteItem(${appData.supplies.indexOf(item)})">削除</button>
                </div>
            `).join('');
        }

        function showAddItemForm() {
            const name = prompt('アイテム名を入力:');
            const quantity = prompt('数量を入力:');
            const expiry = prompt('期限を入力（YYYY-MM-DD）:');
            if (name && quantity && expiry) {
                appData.supplies.push({ name, quantity, expiry });
                saveData();
                renderSupplies();
            }
        }

        function deleteItem(index) {
            if (confirm('本当に削除しますか？')) {
                appData.supplies.splice(index, 1);
                saveData();
                renderSupplies();
            }
        }

        // 掲示板機能
        function postMessage() {
            const text = document.getElementById('newMessage').value;
            if (text) {
                appData.messages.push({
                    text,
                    date: new Date().toLocaleString(),
                    location: [map.getCenter().lat, map.getCenter().lng]
                });
                document.getElementById('newMessage').value = '';
                saveData();
                renderMessages();
                addMessageMarker();
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesList');
            container.innerHTML = appData.messages.map(msg => `
                <div class="message">
                    <p>${msg.date}</p>
                    <p>${msg.text}</p>
                </div>
            `).join('');
        }

        // 地図マーカー管理
        const markers = new L.FeatureGroup();
        map.addLayer(markers);

        function addMessageMarker() {
            const lastMsg = appData.messages[appData.messages.length - 1];
            const marker = L.marker(lastMsg.location)
                .bindPopup(`<b>${lastMsg.date}</b><br>${lastMsg.text}`);
            markers.addLayer(marker);
        }

        // 行動ログ
        function addLogEntry() {
            const text = document.getElementById('newLog').value;
            if (text) {
                appData.logs.push({
                    text,
                    date: new Date().toLocaleString(),
                    advice: generateAdvice(text)
                });
                document.getElementById('newLog').value = '';
                saveData();
                renderLogs();
            }
        }

        function generateAdvice(text) {
            const adviceMap = {
                '水': '水の備蓄は1人あたり1日3リットルが目安です',
                '食料': '長期保存可能な非常食を最低3日分準備しましょう',
                '避難所': '複数の避難経路を確認しておきましょう',
                '懐中電灯': 'LEDタイプで電池式のものを推奨します',
                'ラジオ': '手回し充電式のラジオが便利です'
            };
            return Object.entries(adviceMap).find(([k]) => text.includes(k))?.[1] || '定期的な防災訓練を実施しましょう';
        }

        function renderLogs() {
            const container = document.getElementById('logEntries');
            container.innerHTML = appData.logs.map(log => `
                <div class="message">
                    <p><strong>${log.date}</strong></p>
                    <p>${log.text}</p>
                    <p class="advice">→ ${log.advice}</p>
                </div>
            `).join('');
        }

        // 地図レイヤー切替
        function changeLayer() {
            const selected = document.getElementById('layerSelect').value;
            map.eachLayer(layer => map.removeLayer(layer));
            gsiLayers[selected].addTo(map);
            markers.addTo(map);
        }

        // データ保存
        function saveData() {
            localStorage.setItem('disasterAppData', JSON.stringify(appData));
        }

        // 初期表示
        document.getElementById('supplies').style.display = 'block';
        renderSupplies();
        renderMessages();
        renderLogs();
        appData.messages.forEach(addMessageMarker);
    </script>
</body>
</html>
